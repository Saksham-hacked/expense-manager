# ğŸ”„ Data Flow Diagrams

Visual representations of how data flows through the Backend Orchestrator system.

---

## ğŸ“Š Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER                                 â”‚
â”‚                  (Chrome Extension)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 1. "add 50 rupees burger"
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BACKEND ORCHESTRATOR                        â”‚
â”‚                                                              â”‚
â”‚  Step 1: Authentication                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Verify Google OAuth token                  â”‚           â”‚
â”‚  â”‚  Extract user_id (Google sub)               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  Step 2: Check/Get User from Supabase                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  SELECT * FROM users                        â”‚           â”‚
â”‚  â”‚  WHERE user_id = 'google_sub_123'           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  Step 3: Get User's LLM Key (if BYOK)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  SELECT encrypted_key FROM user_llm_keys    â”‚           â”‚
â”‚  â”‚  WHERE user_id = 'google_sub_123'           â”‚           â”‚
â”‚  â”‚  [Decrypt in memory only]                   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  Step 4: LLM Intent Parsing                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Send to Gemini/OpenAI:                     â”‚           â”‚
â”‚  â”‚  "Convert 'add 50 rupees burger' to JSON"  â”‚           â”‚
â”‚  â”‚                                              â”‚           â”‚
â”‚  â”‚  Response:                                   â”‚           â”‚
â”‚  â”‚  {                                           â”‚           â”‚
â”‚  â”‚    "tool": "add_expense",                   â”‚           â”‚
â”‚  â”‚    "arguments": {                           â”‚           â”‚
â”‚  â”‚      "amount": 50,                          â”‚           â”‚
â”‚  â”‚      "category": "Food",                    â”‚           â”‚
â”‚  â”‚      "merchant": "Burger"                   â”‚           â”‚
â”‚  â”‚    }                                         â”‚           â”‚
â”‚  â”‚  }                                           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  Step 5: Validation                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  â€¢ Check tool is in allow-list              â”‚           â”‚
â”‚  â”‚  â€¢ Validate arguments against schema        â”‚           â”‚
â”‚  â”‚  â€¢ Verify required fields present           â”‚           â”‚
â”‚  â”‚  â€¢ Reject if invalid                        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  Step 6: User ID Injection                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Add user_id to arguments:                  â”‚           â”‚
â”‚  â”‚  {                                           â”‚           â”‚
â”‚  â”‚    "user_id": "google_sub_123",             â”‚           â”‚
â”‚  â”‚    "amount": 50,                            â”‚           â”‚
â”‚  â”‚    "category": "Food",                      â”‚           â”‚
â”‚  â”‚    "merchant": "Burger"                     â”‚           â”‚
â”‚  â”‚  }                                           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 7. MCP Tool Call (HTTP POST)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP SERVER (FastMCP Cloud)                     â”‚
â”‚                                                              â”‚
â”‚  Step 8: Execute Tool                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  INSERT INTO expenses (                     â”‚           â”‚
â”‚  â”‚    user_id, amount, category, merchant      â”‚           â”‚
â”‚  â”‚  ) VALUES (                                  â”‚           â”‚
â”‚  â”‚    'google_sub_123', 50, 'Food', 'Burger'  â”‚           â”‚
â”‚  â”‚  )                                           â”‚           â”‚
â”‚  â”‚  RETURNING expense_id                       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 9. Result: { expense_id: "exp_123" }
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BACKEND ORCHESTRATOR                           â”‚
â”‚                                                              â”‚
â”‚  Step 10: Return to Client                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  {                                           â”‚           â”‚
â”‚  â”‚    "success": true,                         â”‚           â”‚
â”‚  â”‚    "tool": "add_expense",                   â”‚           â”‚
â”‚  â”‚    "result": {                              â”‚           â”‚
â”‚  â”‚      "expense_id": "exp_123",               â”‚           â”‚
â”‚  â”‚      "created_at": "2026-01-15T..."         â”‚           â”‚
â”‚  â”‚    }                                         â”‚           â”‚
â”‚  â”‚  }                                           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                 â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER                                     â”‚
â”‚              (Chrome Extension)                             â”‚
â”‚                                                              â”‚
â”‚  Display: "âœ… Added 50 rupees for Burger"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication Flow (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER       â”‚
â”‚ (Chrome Ext) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. User clicks "Sign in with Google"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google OAuth Popup          â”‚
â”‚  (Handled by Google)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 2. User approves
           â”‚    Returns ID token
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chrome Extension            â”‚
â”‚  - Receives ID token         â”‚
â”‚  - Sends to backend          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ POST /auth/google
           â”‚ { "idToken": "eyJ..." }
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND: /auth/google                    â”‚
â”‚                                            â”‚
â”‚  Step 1: Verify Token                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Use google-auth-library            â”‚ â”‚
â”‚  â”‚  Verify signature with Google       â”‚ â”‚
â”‚  â”‚  Extract payload                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚                 â–¼                          â”‚
â”‚  Step 2: Extract User Info                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  user_id = payload.sub              â”‚ â”‚
â”‚  â”‚  email = payload.email              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚                 â–¼                          â”‚
â”‚  Step 3: Supabase - Create/Get User      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  INSERT INTO users (user_id, email) â”‚ â”‚
â”‚  â”‚  VALUES ('sub_123', 'user@...com')  â”‚ â”‚
â”‚  â”‚  ON CONFLICT (user_id)              â”‚ â”‚
â”‚  â”‚  DO UPDATE SET email = ...          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚                 â–¼                          â”‚
â”‚  Step 4: Generate Session Token          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  sessionToken = crypto.randomBytes  â”‚ â”‚
â”‚  â”‚  sessionStore[token] = {            â”‚ â”‚
â”‚  â”‚    userId: 'sub_123',               â”‚ â”‚
â”‚  â”‚    email: 'user@...com',            â”‚ â”‚
â”‚  â”‚    createdAt: Date.now()            â”‚ â”‚
â”‚  â”‚  }                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Response: { sessionToken, user }
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chrome Extension            â”‚
â”‚  - Saves sessionToken        â”‚
â”‚  - Uses in all requests      â”‚
â”‚  - Authorization: Bearer ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§  LLM Intent Parsing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INPUT                                â”‚
â”‚  "add 50 rupees burger to my expenses"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ POST /llm/intent
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND: llm.js                           â”‚
â”‚                                             â”‚
â”‚  Step 1: Prepare System Prompt             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  You are a tool selector.             â”‚â”‚
â”‚  â”‚  Convert natural language to JSON.    â”‚â”‚
â”‚  â”‚                                        â”‚â”‚
â”‚  â”‚  Available tools:                     â”‚â”‚
â”‚  â”‚  - add_expense                        â”‚â”‚
â”‚  â”‚  - get_expenses                       â”‚â”‚
â”‚  â”‚  - update_expense                     â”‚â”‚
â”‚  â”‚  ...                                  â”‚â”‚
â”‚  â”‚                                        â”‚â”‚
â”‚  â”‚  Schemas:                             â”‚â”‚
â”‚  â”‚  add_expense: {                       â”‚â”‚
â”‚  â”‚    date: string (YYYY-MM-DD),        â”‚â”‚
â”‚  â”‚    amount: number,                    â”‚â”‚
â”‚  â”‚    category: string,                  â”‚â”‚
â”‚  â”‚    merchant: string                   â”‚â”‚
â”‚  â”‚  }                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                  â”‚                          â”‚
â”‚                  â–¼                          â”‚
â”‚  Step 2: Get User's LLM Key (if exists)   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Query Supabase:                      â”‚â”‚
â”‚  â”‚  SELECT encrypted_key                 â”‚â”‚
â”‚  â”‚  FROM user_llm_keys                   â”‚â”‚
â”‚  â”‚  WHERE user_id = 'user_123'           â”‚â”‚
â”‚  â”‚                                        â”‚â”‚
â”‚  â”‚  If found:                            â”‚â”‚
â”‚  â”‚    â€¢ Decrypt using MASTER_KEY         â”‚â”‚
â”‚  â”‚    â€¢ Use for this request             â”‚â”‚
â”‚  â”‚  Else:                                â”‚â”‚
â”‚  â”‚    â€¢ Use DEFAULT_GEMINI_API_KEY       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                  â”‚                          â”‚
â”‚                  â–¼                          â”‚
â”‚  Step 3: Call LLM (Gemini/OpenAI)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  POST to LLM API                      â”‚â”‚
â”‚  â”‚                                        â”‚â”‚
â”‚  â”‚  Payload:                             â”‚â”‚
â”‚  â”‚  {                                    â”‚â”‚
â”‚  â”‚    model: "gemini-pro",               â”‚â”‚
â”‚  â”‚    messages: [                        â”‚â”‚
â”‚  â”‚      {                                â”‚â”‚
â”‚  â”‚        role: "system",                â”‚â”‚
â”‚  â”‚        content: SYSTEM_PROMPT         â”‚â”‚
â”‚  â”‚      },                               â”‚â”‚
â”‚  â”‚      {                                â”‚â”‚
â”‚  â”‚        role: "user",                  â”‚â”‚
â”‚  â”‚        content: "add 50 rupees..."   â”‚â”‚
â”‚  â”‚      }                                â”‚â”‚
â”‚  â”‚    ],                                 â”‚â”‚
â”‚  â”‚    temperature: 0.1                   â”‚â”‚
â”‚  â”‚  }                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                  â”‚                          â”‚
â”‚                  â–¼                          â”‚
â”‚  Step 4: Parse LLM Response                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  LLM returns:                         â”‚â”‚
â”‚  â”‚  ```json                              â”‚â”‚
â”‚  â”‚  {                                    â”‚â”‚
â”‚  â”‚    "tool": "add_expense",             â”‚â”‚
â”‚  â”‚    "arguments": {                     â”‚â”‚
â”‚  â”‚      "date": "2026-01-15",            â”‚â”‚
â”‚  â”‚      "amount": 50,                    â”‚â”‚
â”‚  â”‚      "category": "Food",              â”‚â”‚
â”‚  â”‚      "merchant": "Burger"             â”‚â”‚
â”‚  â”‚    }                                  â”‚â”‚
â”‚  â”‚  }                                    â”‚â”‚
â”‚  â”‚  ```                                  â”‚â”‚
â”‚  â”‚                                        â”‚â”‚
â”‚  â”‚  â€¢ Strip markdown fences              â”‚â”‚
â”‚  â”‚  â€¢ Parse JSON                         â”‚â”‚
â”‚  â”‚  â€¢ Validate structure                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                  â”‚                          â”‚
â”‚                  â–¼                          â”‚
â”‚  Step 5: Validate Against Schema          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Check:                               â”‚â”‚
â”‚  â”‚  âœ“ tool exists in TOOL_SCHEMAS       â”‚â”‚
â”‚  â”‚  âœ“ All required fields present        â”‚â”‚
â”‚  â”‚  âœ“ Field types match                  â”‚â”‚
â”‚  â”‚  âœ“ Values are reasonable              â”‚â”‚
â”‚  â”‚                                        â”‚â”‚
â”‚  â”‚  If invalid:                          â”‚â”‚
â”‚  â”‚    throw ValidationError              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Return validated JSON
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT                                    â”‚
â”‚  Receives:                                 â”‚
â”‚  {                                         â”‚
â”‚    "tool": "add_expense",                  â”‚
â”‚    "arguments": { ... }                    â”‚
â”‚  }                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ BYOK (Bring Your Own Key) Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER                          â”‚
â”‚  Wants to use personal API key â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ POST /llm/keys
                â”‚ {
                â”‚   "provider": "gemini",
                â”‚   "apiKey": "AIza..."
                â”‚ }
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND: routes/llm.js                  â”‚
â”‚                                           â”‚
â”‚  Step 1: Authenticate Request            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Check Authorization header        â”‚ â”‚
â”‚  â”‚  Verify session token              â”‚ â”‚
â”‚  â”‚  Extract user_id                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                          â”‚
â”‚                â–¼                          â”‚
â”‚  Step 2: Validate Input                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Check provider in ['gemini',      â”‚ â”‚
â”‚  â”‚                      'openai']     â”‚ â”‚
â”‚  â”‚  Check apiKey is string            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                          â”‚
â”‚                â–¼                          â”‚
â”‚  Step 3: Encrypt API Key                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  crypto.js:                        â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  â€¢ Generate random IV              â”‚ â”‚
â”‚  â”‚  â€¢ Use AES-256-GCM                 â”‚ â”‚
â”‚  â”‚  â€¢ Encrypt with MASTER_KEY         â”‚ â”‚
â”‚  â”‚  â€¢ Combine: IV + encrypted + tag   â”‚ â”‚
â”‚  â”‚  â€¢ Encode as base64                â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  encryptedKey = "base64string..."  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                          â”‚
â”‚                â–¼                          â”‚
â”‚  Step 4: Store in Supabase              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  INSERT INTO user_llm_keys (       â”‚ â”‚
â”‚  â”‚    user_id,                        â”‚ â”‚
â”‚  â”‚    provider,                       â”‚ â”‚
â”‚  â”‚    encrypted_key                   â”‚ â”‚
â”‚  â”‚  ) VALUES (                         â”‚ â”‚
â”‚  â”‚    'user_123',                     â”‚ â”‚
â”‚  â”‚    'gemini',                       â”‚ â”‚
â”‚  â”‚    'base64encrypted...'            â”‚ â”‚
â”‚  â”‚  )                                  â”‚ â”‚
â”‚  â”‚  ON CONFLICT (user_id)             â”‚ â”‚
â”‚  â”‚  DO UPDATE SET                     â”‚ â”‚
â”‚  â”‚    provider = ...,                 â”‚ â”‚
â”‚  â”‚    encrypted_key = ...,            â”‚ â”‚
â”‚  â”‚    updated_at = NOW()              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Response: { success: true }
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER                          â”‚
â”‚  Key saved!                    â”‚
â”‚  Will be used for all requests â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Later, when user makes a request:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER makes LLM request        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND: llm.js                         â”‚
â”‚                                           â”‚
â”‚  Step 1: Check for User's Key            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SELECT encrypted_key, provider    â”‚ â”‚
â”‚  â”‚  FROM user_llm_keys                â”‚ â”‚
â”‚  â”‚  WHERE user_id = 'user_123'        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                          â”‚
â”‚                â–¼                          â”‚
â”‚  Step 2: If Found, Decrypt               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  crypto.js:                        â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  â€¢ Decode base64                   â”‚ â”‚
â”‚  â”‚  â€¢ Extract IV, encrypted, tag      â”‚ â”‚
â”‚  â”‚  â€¢ Decrypt with MASTER_KEY         â”‚ â”‚
â”‚  â”‚  â€¢ Return plaintext key            â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  apiKey = "AIza..."                â”‚ â”‚
â”‚  â”‚  (IN MEMORY ONLY, NEVER LOGGED)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                          â”‚
â”‚                â–¼                          â”‚
â”‚  Step 3: Use for LLM Request            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Call Gemini API with user's key  â”‚ â”‚
â”‚  â”‚  (Key discarded after use)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Multi-User Isolation

```
User A                    User B
  â”‚                         â”‚
  â”‚ "show my expenses"      â”‚ "show my expenses"
  â–¼                         â–¼
Backend (user_id: A)     Backend (user_id: B)
  â”‚                         â”‚
  â”‚ LLM parses to:          â”‚ LLM parses to:
  â”‚ get_expenses()          â”‚ get_expenses()
  â”‚                         â”‚
  â”‚ Backend injects:        â”‚ Backend injects:
  â”‚ {user_id: "A"}          â”‚ {user_id: "B"}
  â–¼                         â–¼
MCP Server                MCP Server
  â”‚                         â”‚
  â”‚ SELECT * FROM expenses  â”‚ SELECT * FROM expenses
  â”‚ WHERE user_id = 'A'     â”‚ WHERE user_id = 'B'
  â–¼                         â–¼
Results for A             Results for B
  â”‚                         â”‚
  â–¼                         â–¼
User A sees only          User B sees only
their expenses            their expenses
```

**Key Point:** Users NEVER specify their own user_id. Backend ALWAYS injects it.

---

## ğŸ“Š Database Relationships (Supabase)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  users                          â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  user_id (PK) â† Google OAuth    â”‚
â”‚  email                          â”‚
â”‚  created_at                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ 1:1 relationship
             â”‚ (user can have 1 API key)
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user_llm_keys                  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  user_id (PK, FK)               â”‚
â”‚  provider                       â”‚
â”‚  encrypted_key â† AES-256-GCM    â”‚
â”‚  created_at                     â”‚
â”‚  updated_at                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Notes:**
- `user_id` is the Google OAuth `sub` claim
- `encrypted_key` stores the encrypted API key
- Foreign key CASCADE DELETE: deleting user deletes their key
- Row Level Security (RLS) enabled on both tables

---

## ğŸ”„ Error Handling Flow

```
Request
  â”‚
  â”œâ”€â†’ âŒ Invalid session token
  â”‚     â†’ 401 Unauthorized
  â”‚
  â”œâ”€â†’ âŒ User not found
  â”‚     â†’ 404 Not Found
  â”‚
  â”œâ”€â†’ âŒ LLM returns invalid JSON
  â”‚     â†’ 400 Bad Request (retry with different prompt)
  â”‚
  â”œâ”€â†’ âŒ Tool not in allow-list
  â”‚     â†’ 403 Forbidden
  â”‚
  â”œâ”€â†’ âŒ Missing required parameters
  â”‚     â†’ 400 Bad Request
  â”‚
  â”œâ”€â†’ âŒ MCP server unreachable
  â”‚     â†’ 503 Service Unavailable
  â”‚
  â”œâ”€â†’ âŒ MCP tool execution fails
  â”‚     â†’ 500 Internal Server Error
  â”‚         (but with details from MCP)
  â”‚
  â””â”€â†’ âœ… All validations pass
        â†’ Execute tool
        â†’ Return result
```

---

## ğŸ¨ Data Format Examples

### User Record (Supabase)
```json
{
  "user_id": "google_oauth_sub_123456789",
  "email": "user@example.com",
  "created_at": "2026-01-15T10:30:00Z"
}
```

### Encrypted Key Record
```json
{
  "user_id": "google_oauth_sub_123456789",
  "provider": "gemini",
  "encrypted_key": "IV:encrypted_data:auth_tag (base64)",
  "created_at": "2026-01-15T10:35:00Z",
  "updated_at": "2026-01-15T10:35:00Z"
}
```

### LLM Request/Response
```json
// Request to LLM
{
  "model": "gemini-pro",
  "messages": [
    { "role": "system", "content": "You are a tool selector..." },
    { "role": "user", "content": "add 50 rupees burger" }
  ],
  "temperature": 0.1
}

// Response from LLM
{
  "content": [
    {
      "type": "text",
      "text": "{\n  \"tool\": \"add_expense\",\n  \"arguments\": {...}\n}"
    }
  ]
}
```

### MCP Tool Call
```json
{
  "tool": "add_expense",
  "arguments": {
    "user_id": "google_oauth_sub_123456789",  // Injected by backend
    "date": "2026-01-15",
    "amount": 50,
    "category": "Food",
    "merchant": "Burger",
    "note": "lunch"
  }
}
```

---

These diagrams show the complete data flow through your system. Use them to:
- âœ… Understand the architecture
- âœ… Debug issues
- âœ… Explain to interviewers
- âœ… Plan new features
